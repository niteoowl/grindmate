<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>무기타파 RPG</title>
    <!-- Galmuri 폰트 로드 -->
    <link rel="stylesheet" href="https://fastly.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css">
    <!-- Font Awesome 아이콘 라이브러리 로드 -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <style>
        body {
            margin: 0; padding: 0; overflow-x: hidden; background-color: #f0f0f0;
            display: flex; justify-content: center; min-height: 100vh; align-items: flex-start;
            font-family: 'Galmuri11', sans-serif;
        }
        .container {
            width: 480px; padding: 0; box-sizing: border-box; background-color: #fff;
            min-height: 100vh; background-image: url('https://i.postimg.cc/pr8fzDXr/2.png');
            background-size: contain; background-repeat: repeat; background-position: center center;
            background-attachment: fixed;
        }
        .top-bar {
            width: 100%; height: 60px; background-color: #000; padding: 0 20px; box-sizing: border-box;
            display: flex; justify-content: space-between; align-items: center; color: white;
            border-radius: 0; font-size: 0.9em;
        }
        .game-info { display: flex; align-items: center; gap: 15px; }
        .game-info-item {
            display: flex; align-items: center; background-color: rgba(255, 255, 255, 0.1);
            padding: 4px 8px; border-radius: 0; font-weight: bold; font-size: 0.85em;
            border: 1px solid rgba(255, 255, 255, 0.2); box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.5);
        }
        .game-info-item.level, .game-info-item.gold { color: #FFD700; }
        .game-info-item.exp { color: #7FFF00; }
        .icon { margin-right: 5px; font-size: 1.1em; }
        .content-area { padding: 20px; box-sizing: border-box; width: 100%; }

        /* Common Panel Style */
        .panel {
            background-color: rgba(255, 255, 255, 0.9); border-radius: 0; padding: 20px;
            margin-bottom: 20px; border: 2px solid #555; box-shadow: 4px 4px 0px #333; color: #333;
        }
        .panel h2 {
            font-size: 1.3em; color: #000; margin-top: 0; margin-bottom: 15px;
            border-bottom: 2px solid #eee; padding-bottom: 5px; display: flex; align-items: center;
        }

        /* Profile Section */
        .profile-section { cursor: pointer; overflow: hidden; transition: max-height 0.5s ease-out; }
        .profile-section.collapsed { max-height: 70px; padding-bottom: 0; }
        .profile-section:not(.collapsed) { max-height: 500px; padding-bottom: 20px; }
        .profile-section h2 { justify-content: space-between; }
        .profile-section.collapsed .profile-content { display: none; }
        .profile-stats, .profile-equipment { margin-bottom: 15px; }
        .profile-stats ul, .profile-equipment ul { list-style: none; padding: 0; margin: 0; }
        .profile-stats li, .profile-equipment li { display: flex; align-items: center; margin-bottom: 8px; font-size: 1em; font-weight: 500; }
        .profile-stats li .stat-value, .profile-equipment li .equipment-value { margin-left: auto; font-weight: bold; color: #555; }
        .profile-equipment li .equipment-name { margin-left: 5px; color: #555; }
        .profile-icon { margin-right: 10px; color: #666; font-size: 1.2em; width: 20px; text-align: center; }
        .toggle-icon { font-size: 1em; color: #000; transition: transform 0.3s ease-in-out; }
        .profile-section.collapsed .toggle-icon { transform: rotate(0deg); }
        .profile-section:not(.collapsed) .toggle-icon { transform: rotate(180deg); }
        .profile-avatar {
            width: 80px; height: 80px; border-radius: 0; border: 2px solid #555;
            box-shadow: 2px 2px 0px #333; margin-bottom: 15px; background-color: #ccc;
            display: flex; justify-content: center; align-items: center; font-size: 2em;
            color: #666; overflow: hidden; image-rendering: pixelated;
        }

        /* Combat Panel */
        .combat-panel .combat-icon { margin-right: 10px; color: #d9534f; font-size: 1.2em; }
        .combat-info { display: flex; flex-direction: column; gap: 10px; }
        .combat-info-item { display: flex; justify-content: space-between; align-items: center; font-size: 1em; }
        .combat-info-item .label { font-weight: bold; color: #555; }
        .combat-info-item .value { color: #333; }
        .health-bar-container {
            width: 100%; background-color: #e0e0e0; border-radius: 0; height: 20px;
            overflow: hidden; margin-top: 5px; border: 1px solid #555; box-shadow: 1px 1px 0px #333;
        }
        .health-bar { height: 100%; width: 0%; background-color: #d9534f; border-radius: 0; transition: width 0.5s ease-in-out; }
        .monster-graphic {
            width: 150px; height: 150px; background-color: #eee; border: 2px solid #555;
            box-shadow: 3px 3px 0px #333; margin: 20px auto; display: flex;
            justify-content: center; align-items: center; font-size: 1.5em;
            color: #666; image-rendering: pixelated; object-fit: contain;
        }
        .combat-log {
            background-color: #e0e0e0; border: 2px solid #555; box-shadow: 2px 2px 0px #333;
            padding: 10px; height: 100px; overflow-y: auto; font-size: 0.9em;
            color: #333; margin-top: 15px;
        }

        /* Action Input Panel */
        .action-input-panel { display: flex; flex-direction: column; gap: 15px; }
        .time-input-group { display: flex; gap: 10px; align-items: center; }
        .time-input-group input { flex: 1; }
        .time-input-group span { font-weight: bold; color: #555; }

        /* Inventory Panel */
        .inventory-panel { min-height: 200px; }
        .item-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            gap: 10px; margin-top: 15px;
        }
        .item-card {
            background-color: #e0e0e0; border: 2px solid #555; box-shadow: 2px 2px 0px #333;
            padding: 10px; text-align: center; font-size: 0.85em; cursor: pointer;
            transition: transform 0.1s ease-out; position: relative; overflow: hidden;
        }
        .item-card:hover { transform: translate(-1px, -1px); box-shadow: 3px 3px 0px #333; }
        .item-card img {
            width: 60px; height: 60px; object-fit: contain; image-rendering: pixelated;
            margin: 0 auto 5px;
        }
        .item-card .item-name { font-weight: bold; color: #000; }
        .item-card .item-rarity { font-size: 0.75em; color: #666; }
        .item-card .item-price { font-weight: bold; color: #d9534f; margin-top: 5px; }
        .item-card .use-button, .item-card .buy-button {
            display: block; width: 100%; padding: 5px; margin-top: 8px;
            background-color: #007bff; color: white; border: none; border-radius: 0;
            font-size: 0.8em; font-weight: bold; cursor: pointer;
            box-shadow: 1px 1px 0px #0056b3; transition: background-color 0.1s;
        }
        .item-card .use-button:hover, .item-card .buy-button:hover { background-color: #0056b3; }
        .item-card .rarity-common { color: #666; }
        .item-card .rarity-rare { color: #007bff; }
        .item-card .rarity-epic { color: #9400d3; }
        .item-card .rarity-legendary { color: #FFD700; }

        /* Common Input Field Style */
        .input-field {
            width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 0;
            box-sizing: border-box; font-size: 1em;
        }

        /* Common Button Style */
        .pixel-button {
            display: inline-flex; align-items: center; justify-content: center;
            padding: 12px 20px; border: none; border-radius: 0; font-size: 1.1em;
            font-weight: bold; cursor: pointer; transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
            color: white; text-shadow: 1px 1px 0px rgba(0,0,0,0.5); position: relative;
        }
        .pixel-button:hover { transform: translate(0, -2px); box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.6); }
        .pixel-button:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.5); }
        .pixel-button:disabled { background-color: #888; box-shadow: 4px 4px 0px #666; cursor: not-allowed; }

        /* Button Colors */
        .main-button { background-color: #007bff; box-shadow: 4px 4px 0px #0056b3; }
        .complete-button { background-color: #28a745; box-shadow: 4px 4px 0px #1e7e34; }
        .inventory-button { background-color: #17a2b8; box-shadow: 4px 4px 0px #138496; }

        /* Bottom Icon */
        .bottom-icon-wrapper {
            display: flex;
            justify-content: center;
            gap: 20px; /* 아이콘 간격 추가 */
            margin-top: 20px;
            padding-bottom: 20px;
        }
        .bottom-icon { width: 120px; height: 120px; object-fit: contain; image-rendering: pixelated; cursor: pointer; }

        /* Modal Style */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center;
            align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: #fff; border: 2px solid #555; box-shadow: 6px 6px 0px #333;
            padding: 30px; text-align: center; max-width: 400px; width: 90%; color: #333; position: relative;
        }
        .modal-content h3 {
            font-size: 1.5em; color: #000; margin-bottom: 15px;
            border-bottom: 2px solid #eee; padding-bottom: 5px;
        }
        .modal-content p { margin-bottom: 20px; font-size: 1em; line-height: 1.5; white-space: pre-wrap; }
        .modal-rewards-grid {
            display: grid; grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px; margin-bottom: 20px;
        }
        .modal-reward-item {
            background-color: #e0e0e0; border: 2px solid #555; box-shadow: 2px 2px 0px #333;
            padding: 10px; font-size: 0.85em; font-weight: bold; color: #333;
        }
        .modal-close-button {
            background-color: #007bff; box-shadow: 4px 4px 0px #0056b3; color: white;
            padding: 10px 20px; font-size: 1em; font-weight: bold; cursor: pointer;
            border: none; border-radius: 0; transition: transform 0.1s ease-out, box-shadow 0.1s ease-out;
        }
        .modal-close-button:hover { transform: translate(0, -2px); box-shadow: 6px 6px 0px rgba(0, 0, 0, 0.6); }
        .modal-close-button:active { transform: translate(2px, 2px); box-shadow: 2px 2px 0px rgba(0, 0, 0, 0.5); }

        .hidden { display: none; }

        /* Media Queries */
        @media (min-width: 768px) {
            .top-bar { padding: 0 30px; } .content-area { padding: 30px; }
            .panel { padding: 25px; } .profile-section.collapsed { max-height: 75px; }
        }
        @media (min-width: 1024px) {
            .top-bar { padding: 0 40px; } .content-area { padding: 40px; }
            .panel { padding: 30px; } .profile-section.collapsed { max-height: 80px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="top-bar">
            <span style="font-weight: bold;">무기타파 RPG</span>
            <div class="game-info">
                <div class="game-info-item level"><i class="fas fa-star icon"></i>LV.<span id="character-level">1</span></div>
                <div class="game-info-item exp"><i class="fas fa-bolt icon"></i><span id="exp-text">0/100</span> EXP</div>
                <div class="game-info-item gold"><i class="fas fa-coins icon"></i><span id="character-gold">0</span>골드</div>
            </div>
        </div>
        <div class="content-area">
            <div class="panel" style="font-size: 0.8em; text-align: center; margin-bottom: 10px; padding: 10px;">
                <span id="user-id-display">User ID: Loading...</span>
            </div>

            <!-- Game Content Wrapper -->
            <div id="gameContent" class="hidden">
                <div id="profileSection" class="panel profile-section collapsed">
                    <h2>
                        <span><i class="fas fa-user-circle profile-icon"></i>프로필</span>
                        <i class="fas fa-chevron-down toggle-icon"></i>
                    </h2>
                    <div class="profile-content">
                        <div class="profile-avatar">
                            <img id="character-avatar" src="https://placehold.co/80x80/666/ffffff?text=AVATAR" alt="Character Avatar" style="width: 100%; height: 100%; object-fit: cover; image-rendering: pixelated;">
                        </div>
                        <div class="profile-stats">
                            <h3>능력치</h3>
                            <ul>
                                <li><i class="fas fa-fist-raised profile-icon"></i>힘: <span id="stat-strength" class="stat-value">10</span></li>
                                <li><i class="fas fa-brain profile-icon"></i>지능: <span id="stat-intelligence" class="stat-value">10</span></li>
                                <li><i class="fas fa-shield-alt profile-icon"></i>인내력: <span id="stat-endurance" class="stat-value">10</span></li>
                            </ul>
                        </div>
                        <div class="profile-equipment">
                            <h3>장비</h3>
                            <ul>
                                <li><i class="fas fa-sword profile-icon"></i>무기: <span id="equipped-weapon" class="equipment-name">낡은 검</span></li>
                                <li><i class="fas fa-tshirt profile-icon"></i>방어구: <span id="equipped-armor" class="equipment-name">낡은 갑옷</span></li>
                            </ul>
                        </div>
                    </div>
                </div>

                <div id="actionInputPanel" class="panel action-input-panel">
                    <h2>행동 입력</h2>
                    <input type="text" id="actionNameInput" placeholder="수행할 행동 (예: 공부, 청소)" class="input-field">
                    <div class="time-input-group">
                        <input type="number" id="hoursInput" placeholder="시간" min="0" class="input-field">
                        <span>시간</span>
                        <input type="number" id="minutesInput" placeholder="분" min="0" max="59" class="input-field">
                        <span>분</span>
                    </div>
                    <button id="startButton" class="pixel-button main-button">행동 시작</button>
                </div>

                <div id="combatPanel" class="panel combat-panel hidden">
                    <h2>
                        <i class="fas fa-swords combat-icon"></i>전투 진행
                    </h2>
                    <div class="combat-info">
                        <div class="combat-info-item">
                            <span class="label">현재 행동:</span>
                            <span id="currentActionName" class="value"></span>
                        </div>
                        <div class="combat-info-item">
                            <span class="label">몬스터:</span>
                            <span id="currentMonsterName" class="value"></span>
                        </div>
                        <img id="monster-graphic" src="https://placehold.co/150x150/FF6347/FFFFFF?text=MONSTER" alt="Monster Graphic" class="monster-graphic">
                        <div class="combat-info-item">
                            <span class="label">남은 시간:</span>
                            <span id="remainingTime" class="value">00:00</span>
                        </div>
                        <button id="completeActionButton" class="pixel-button complete-button">처치 완료</button>
                    </div>
                    <div id="combat-log" class="combat-log">
                        <!-- 전투 로그가 여기에 표시됩니다. -->
                    </div>
                </div>

                <div id="inventoryPanel" class="panel inventory-panel">
                    <h2><i class="fas fa-briefcase profile-icon"></i>인벤토리</h2>
                    <div id="inventory-list" class="item-grid">
                        <!-- 인벤토리 내용은 모달로 표시되므로, 여기는 비워둡니다. -->
                        <p class="col-span-full text-center text-gray-600" id="empty-inventory-message">인벤토리가 비어있습니다.</p>
                    </div>
                    <!-- 인벤토리 관리 버튼 삭제 -->
                </div>

                <!-- 하단 아이콘 -->
                <div class="bottom-icon-wrapper">
                    <img id="bottomIcon" src="https://i.postimg.cc/rp2ww3Kv/little-shop-stand-pixel-art-style-475147-1401-Photoroom.png" alt="상점 아이콘" class="bottom-icon">
                    <img id="bottomInventoryIcon" src="https://i.postimg.cc/k47b74G5/photo2pixel-download-2.png" alt="인벤토리 아이콘" class="bottom-icon">
                </div>
            </div> <!-- End of gameContent -->

            <!-- Login Required Message -->
            <div id="loginRequiredMessage" class="panel" style="text-align: center; padding: 50px; margin-top: 50px;">
                <h2>로그인이 필요합니다</h2>
                <p>게임을 플레이하려면 로그인해주세요.</p>
                <p style="font-size: 0.9em; color: #888;">(로그인 페이지는 별도로 제공됩니다.)</p>
            </div>
        </div>
    </div>

    <!-- 모달 컨테이너 -->
    <div id="modal-overlay" class="modal-overlay hidden">
        <div id="modal-content" class="modal-content">
            <h3 id="modal-title"></h3>
            <p id="modal-message"></p>
            <div id="modal-rewards" class="modal-rewards-grid"></div>
            <button id="modal-close-button" class="modal-close-button">확인</button>
        </div>
    </div>

    <script type="module">
        // Firebase SDK imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, onSnapshot, collection, query, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase config - directly provided by user
        const firebaseConfig = {
            apiKey: "AIzaSyALUv0zMoBExmhZJd2idSfmB_-DbPAAdL8",
            authDomain: "grind-mate-a.firebaseapp.com",
            projectId: "grind-mate-a",
            storageBucket: "grind-mate-a.firebasestorage.app",
            messagingSenderId: "704910171892",
            appId: "1:704910171892:web:908b2b625e46aa7a5e48a1",
            measurementId: "G-WQH66CMVP1"
        };
        // Use projectId as appId for consistency with Firestore rules
        const appId = firebaseConfig.projectId;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let app, db, auth, userId = null, isAuthReady = false;

        // Game State Variables
        let character = {
            level: 1, exp: 0, expToNextLevel: 100, gold: 0,
            strength: 10, intelligence: 10, endurance: 10,
            equipped: { weapon: { name: "낡은 검", attack: 5 }, armor: { name: "낡은 갑옷", defense: 3 } },
            inventory: []
        };

        let currentAction = {
            name: "", duration: 0, timer: null, intervalId: null, startTime: 0, monster: null
        };

        const monsters = [
            { name: "슬라임", hp: 20, exp: 10, gold: 5, theme: ["공부", "청소"], graphic: "https://placehold.co/150x150/A3E635/FFFFFF?text=SLIME" },
            { name: "고블린", hp: 30, exp: 15, gold: 8, theme: ["운동", "요리"], graphic: "https://placehold.co/150x150/EF4444/FFFFFF?text=GOBLIN" },
            { name: "오크 전사", hp: 50, exp: 25, gold: 12, theme: ["업무", "창작"], graphic: "https://placehold.co/150x150/F97316/FFFFFF?text=ORC" },
            { name: "어둠의 마법사", hp: 70, exp: 35, gold: 18, theme: ["독서", "연구"], graphic: "https://placehold.co/150x150/8B5CF6/FFFFFF?text=WIZARD" }
        ];

        const items = [
            { id: "exp_boost_potion", name: "경험치 부스트 포션", rarity: "희귀", effect: { type: "exp_multiplier", value: 1.5, duration: 600 }, description: "10분간 경험치 획득량 1.5배 증가", graphic: "https://placehold.co/60x60/818CF8/FFFFFF?text=EXP" },
            { id: "gold_bag", name: "황금 주머니", rarity: "일반", effect: { type: "gold_bonus", value: 50 }, description: "골드 50 획득", graphic: "https://placehold.co/60x60/FCD34D/FFFFFF?text=GOLD" },
            { id: "rest_ticket", name: "휴식 티켓", rarity: "영웅", effect: { type: "auto_complete_action", value: 300 }, description: "5분 미만 행동 즉시 완료", graphic: "https://placehold.co/60x60/EC4899/FFFFFF?text=REST" },
            { id: "legendary_sword", name: "전설의 검", rarity: "전설", effect: { type: "weapon", attack: 50 }, description: "공격력 50 증가", graphic: "https://placehold.co/60x60/FACC15/000000?text=SWORD" }
        ];

        // Shop items (Distraction Coupons)
        const shopItems = [];
        for (let i = 1; i <= 6; i++) {
            const durationMinutes = i * 10;
            const price = 30 + (i - 1) * 10;
            shopItems.push({
                id: `distraction_coupon_${durationMinutes}m`,
                name: `딴짓 쿠폰 (${durationMinutes}분)`,
                price: price, type: "consumable", rarity: "일반",
                effect: { type: "auto_complete_action", value: durationMinutes * 60 },
                description: `${durationMinutes}분 미만 행동 즉시 완료 (기능 미구현)`,
                graphic: "https://i.postimg.cc/vmQ8F91n/photo2pixel-download-1.png"
            });
        }

        // UI Elements
        const [
            userIdDisplayEl, characterLevelEl, expTextEl, characterGoldEl,
            statStrengthEl, statIntelligenceEl, statEnduranceEl,
            equippedWeaponEl, equippedArmorEl, characterAvatarEl,
            profileSection, actionInputPanel, actionNameInput,
            hoursInput, minutesInput, startButton, combatPanel,
            currentActionNameEl, currentMonsterNameEl, monsterGraphicEl,
            remainingTimeSpan, completeActionButton, combatLogEl,
            inventoryPanel, inventoryListEl, emptyInventoryMessage,
            bottomIcon, bottomInventoryIcon, modalOverlay,
            modalContent, modalTitle, modalMessage, modalRewards, modalCloseButton,
            gameContentEl, loginRequiredMessageEl // New UI elements
        ] = [
            'user-id-display', 'character-level', 'exp-text', 'character-gold',
            'stat-strength', 'stat-intelligence', 'stat-endurance',
            'equipped-weapon', 'equipped-armor', 'character-avatar',
            'profileSection', 'actionInputPanel', 'actionNameInput',
            'hoursInput', 'minutesInput', 'startButton', 'combatPanel',
            'currentActionName', 'currentMonsterName', 'monster-graphic',
            'remainingTime', 'completeActionButton', 'combat-log',
            'inventoryPanel', 'inventory-list', 'empty-inventory-message',
            'bottomIcon', 'bottomInventoryIcon', 'modal-overlay',
            'modal-content', 'modal-title', 'modal-message', 'modal-rewards', 'modal-close-button',
            'gameContent', 'loginRequiredMessage' // New IDs
        ].map(id => document.getElementById(id));

        const toggleIcon = profileSection.querySelector('.toggle-icon');
        const shopListEl = document.createElement('div'); // Temp div for shop items in modal
        shopListEl.className = 'item-grid';

        // Firebase Initialization and Authentication
        const initializeFirebase = async () => {
            try {
                app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdDisplayEl.textContent = `User ID: ${userId}`;
                        isAuthReady = true;
                        toggleGameUI(true); // Show game UI
                        await loadCharacterData();
                    } else {
                        userId = null; // Clear userId if not logged in
                        isAuthReady = false;
                        toggleGameUI(false); // Hide game UI, show login message
                        addCombatLog("로그인이 필요합니다.");
                    }
                });
            } catch (error) {
                console.error("Firebase init failed:", error);
                userIdDisplayEl.textContent = `User ID: Error`;
                toggleGameUI(false); // Hide game UI on error too
            }
        };

        // Function to toggle game UI based on login status
        const toggleGameUI = (loggedIn) => {
            if (loggedIn) {
                gameContentEl.classList.remove('hidden');
                loginRequiredMessageEl.classList.add('hidden');
                // Enable all game inputs/buttons
                startButton.disabled = false;
                actionNameInput.disabled = false;
                hoursInput.disabled = false;
                minutesInput.disabled = false;
                bottomIcon.style.pointerEvents = 'auto'; // Enable shop icon
                bottomInventoryIcon.style.pointerEvents = 'auto'; // Enable inventory icon
                bottomIcon.style.opacity = '1'; // Make icons visible
                bottomInventoryIcon.style.opacity = '1';
            } else {
                gameContentEl.classList.add('hidden');
                loginRequiredMessageEl.classList.remove('hidden');
                // Disable all game inputs/buttons
                startButton.disabled = true;
                actionNameInput.disabled = true;
                hoursInput.disabled = true;
                minutesInput.disabled = true;
                completeActionButton.disabled = true; // Also disable complete action button if combat is active
                bottomIcon.style.pointerEvents = 'none'; // Disable shop icon
                bottomInventoryIcon.style.pointerEvents = 'none'; // Disable inventory icon
                bottomIcon.style.opacity = '0.5'; // Make icons semi-transparent
                bottomInventoryIcon.style.opacity = '0.5';
            }
        };


        // Firestore Data Operations
        const getCharacterDocRef = () => userId ? doc(db, `artifacts/${appId}/users/${userId}/characterData`, "mainCharacter") : null;

        const loadCharacterData = async () => {
            if (!isAuthReady || !userId) return;
            const charDocRef = getCharacterDocRef();
            if (!charDocRef) return;
            onSnapshot(charDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    character = { ...data, equipped: JSON.parse(data.equipped), inventory: JSON.parse(data.inventory) };
                    updateUI();
                } else {
                    initializeCharacter();
                }
            }, (error) => console.error("Error listening to character data:", error));
        };

        const saveCharacterData = async () => {
            if (!isAuthReady || !userId) return;
            const charDocRef = getCharacterDocRef();
            if (!charDocRef) return;
            try {
                const dataToSave = {
                    ...character, equipped: JSON.stringify(character.equipped),
                    inventory: JSON.stringify(character.inventory), lastUpdated: serverTimestamp()
                };
                await setDoc(charDocRef, dataToSave, { merge: true });
            } catch (error) { console.error("Error saving character data:", error); }
        };

        // Game Logic
        const initializeCharacter = () => {
            character = {
                level: 1, exp: 0, expToNextLevel: 100, gold: 0,
                strength: 10, intelligence: 10, endurance: 10,
                equipped: { weapon: { name: "낡은 검", attack: 5 }, armor: { name: "낡은 갑옷", defense: 3 } },
                inventory: []
            };
            saveCharacterData();
            updateUI();
        };

        const updateUI = () => {
            characterLevelEl.textContent = character.level;
            expTextEl.textContent = `${character.exp}/${character.expToNextLevel}`;
            characterGoldEl.textContent = character.gold;
            statStrengthEl.textContent = character.strength;
            statIntelligenceEl.textContent = character.intelligence;
            statEnduranceEl.textContent = character.endurance;
            equippedWeaponEl.textContent = character.equipped.weapon.name;
            equippedArmorEl.textContent = character.equipped.armor.name;
            // renderInventory is now called only when the icon is clicked to show the modal
        };

        const startAction = () => {
            if (!isAuthReady || !userId) {
                showModal("로그인 필요", "행동을 시작하려면 로그인해야 합니다.");
                return;
            }

            const actionText = actionNameInput.value.trim();
            const hoursValue = parseInt(hoursInput.value, 10) || 0;
            const minutesValue = parseInt(minutesInput.value, 10) || 0;

            if (!actionText) { showModal("오류", "수행할 행동 이름을 입력해주세요!"); return; }
            if ((hoursValue === 0 && minutesValue === 0) || isNaN(hoursValue) || isNaN(minutesValue) || minutesValue < 0 || minutesValue > 59) {
                showModal("오류", "유효한 시간과 분을 입력해주세요."); return;
            }

            const durationSeconds = (hoursValue * 3600) + (minutesValue * 60);
            if (durationSeconds <= 0) { showModal("오류", "유효한 시간을 입력해주세요."); return; }

            currentAction.name = actionText; currentAction.duration = durationSeconds;
            currentAction.timer = durationSeconds; currentAction.startTime = Date.now();

            const filteredMonsters = monsters.filter(m => m.theme.some(t => actionText.includes(t)));
            currentAction.monster = filteredMonsters.length > 0 ?
                                    filteredMonsters[Math.floor(Math.random() * filteredMonsters.length)] :
                                    monsters[Math.floor(Math.random() * monsters.length)];

            actionInputPanel.classList.add('hidden'); combatPanel.classList.remove('hidden');
            currentActionNameEl.textContent = currentAction.name;
            currentMonsterNameEl.textContent = currentAction.monster.name;
            monsterGraphicEl.src = currentAction.monster.graphic;
            monsterGraphicEl.classList.remove('hidden'); completeActionButton.classList.remove('hidden');
            startButton.disabled = true; actionNameInput.disabled = true;
            hoursInput.disabled = true; minutesInput.disabled = true;

            addCombatLog(`'${currentAction.name}' 행동 시작! ${currentAction.monster.name} 출현!`);
            startCombatTimer();
        };

        const startCombatTimer = () => {
            clearInterval(currentAction.intervalId);
            currentAction.intervalId = setInterval(() => {
                currentAction.timer--;
                const h = Math.floor(currentAction.timer / 3600);
                const m = Math.floor((currentAction.timer % 3600) / 60);
                const s = currentAction.timer % 60;
                remainingTimeSpan.textContent = `${String(h).padStart(2, '0')}시간 ${String(m).padStart(2, '0')}분 ${String(s).padStart(2, '0')}초`;
                if (currentAction.timer <= 0) { clearInterval(currentAction.intervalId); addCombatLog(`행동 시간 종료!`); }
            }, 1000);
        };

        const completeAction = () => {
            if (!isAuthReady || !userId) {
                showModal("로그인 필요", "행동을 완료하려면 로그인해야 합니다.");
                return;
            }
            clearInterval(currentAction.intervalId); // Stop timer

            // UI 초기화
            actionInputPanel.classList.remove('hidden'); combatPanel.classList.add('hidden');
            monsterGraphicEl.classList.add('hidden'); completeActionButton.classList.add('hidden');
            startButton.disabled = false; actionNameInput.disabled = false;
            hoursInput.disabled = false; minutesInput.disabled = false;
            actionNameInput.value = ''; hoursInput.value = ''; minutesInput.value = '';
            remainingTimeSpan.textContent = "00:00:00"; // Reset timer display

            const actualDuration = Math.min(currentAction.duration, (Date.now() - currentAction.startTime) / 1000); // How long they actually spent
            const isFullyCompleted = (currentAction.timer <= 0); // Check if the timer ran out

            // Base rewards scale with actual duration
            let awardedExp = Math.floor(actualDuration / 60) * 5; // 5 EXP per minute spent
            let awardedGold = Math.floor(actualDuration / 60) * 2; // 2 Gold per minute spent

            // Add some randomness
            awardedExp += Math.floor(Math.random() * 10);
            awardedGold += Math.floor(Math.random() * 5);

            let completionBonusMessage = "";
            if (isFullyCompleted) {
                // Apply a bonus for full completion
                const bonusMultiplier = 1.2; // 20% bonus for full completion
                awardedExp = Math.floor(awardedExp * bonusMultiplier);
                awardedGold = Math.floor(awardedGold * bonusMultiplier);
                completionBonusMessage = "\n(행동을 완수하여 추가 보너스 획득!)";
            } else {
                completionBonusMessage = "\n(행동을 일찍 종료하여 보너스가 없습니다.)";
            }

            character.exp += awardedExp; character.gold += awardedGold;

            // Stat increase (random)
            const statIncreaseAmount = Math.floor(Math.random() * 3) + 1;
            const statsToIncrease = ['strength', 'intelligence', 'endurance'];
            const randomStat = statsToIncrease[Math.floor(Math.random() * statsToIncrease.length)];
            character[randomStat] += statIncreaseAmount;

            addCombatLog(`'${currentAction.name}' 완료!`);
            addCombatLog(`경험치 +${awardedExp}, 골드 +${awardedGold}, ${randomStat === 'strength' ? '힘' : randomStat === 'intelligence' ? '지능' : '인내력'} +${statIncreaseAmount} 획득!${completionBonusMessage}`);

            checkLevelUp();
            const droppedItem = rollForItemDrop();
            let rewardsHtml = `
                <div class="modal-reward-item"><p>경험치</p><p>+${awardedExp}</p></div>
                <div class="modal-reward-item"><p>골드</p><p>+${awardedGold}</p></div>
                <div class="modal-reward-item"><p>${randomStat === 'strength' ? '힘' : randomStat === 'intelligence' ? '지능' : '인내력'}</p><p>+${statIncreaseAmount}</p></div>
            `;
            if (droppedItem) {
                character.inventory.push(droppedItem);
                rewardsHtml += `
                    <div class="modal-reward-item">
                        <img src="${droppedItem.graphic || 'https://placehold.co/60x60/FFD700/000000?text=ITEM'}" alt="Item Icon" style="width: 100%; height: auto; image-rendering: pixelated; margin-bottom: 5px;">
                        <p>${droppedItem.name}</p>
                        <p class="item-rarity ${getRarityClass(droppedItem.rarity)}">(${droppedItem.rarity})</p>
                    </div>
                `;
                addCombatLog(`아이템 획득: ${droppedItem.name} (${droppedItem.rarity})`);
            }
            showModal("행동 완료!", `보상을 획득했습니다!${completionBonusMessage}`, rewardsHtml);
            updateUI();
            saveCharacterData();
        };

        const checkLevelUp = () => {
            while (character.exp >= character.expToNextLevel) {
                character.level++; character.exp -= character.expToNextLevel;
                character.expToNextLevel = Math.floor(character.expToNextLevel * 1.5);
                character.strength += 2; character.intelligence += 2; character.endurance += 2;
                addCombatLog(`레벨업! 현재 레벨: ${character.level}`);
                showModal("레벨업!", `축하합니다! 레벨 ${character.level} 달성! 능력치가 상승했습니다!`);
            }
        };

        // Item Drop & Card System
        const rollForItemDrop = () => {
            const dropChance = 0.3;
            if (Math.random() < dropChance) {
                const rarityRoll = Math.random();
                let rarity = "일반";
                if (rarityRoll < 0.05) rarity = "전설";
                else if (rarityRoll < 0.15) rarity = "영웅";
                else if (rarityRoll < 0.4) rarity = "희귀";
                const availableItems = items.filter(item => item.rarity === rarity);
                if (availableItems.length > 0) return { ...availableItems[Math.floor(Math.random() * availableItems.length)] };
            }
            return null;
        };

        const getRarityClass = (rarity) => {
            switch (rarity) {
                case "일반": return "rarity-common"; case "희귀": return "rarity-rare";
                case "영웅": return "rarity-epic"; case "전설": return "rarity-legendary";
                default: return "";
            }
        };

        const renderInventory = () => {
            if (!isAuthReady || !userId) {
                showModal("로그인 필요", "인벤토리를 보려면 로그인해야 합니다.");
                return;
            }

            const inventoryModalContentDiv = document.createElement('div');
            inventoryModalContentDiv.className = 'item-grid';

            if (character.inventory.length === 0) {
                inventoryModalContentDiv.innerHTML = '<p class="col-span-full text-center text-gray-600">인벤토리가 비어있습니다.</p>';
            } else {
                character.inventory.forEach((item, index) => {
                    const itemCard = document.createElement('div');
                    itemCard.className = 'item-card';
                    itemCard.innerHTML = `
                        <img src="${item.graphic || 'https://placehold.co/60x60/FFD700/000000?text=ITEM'}" alt="Item Icon">
                        <p class="item-name">${item.name}</p>
                        <p class="item-rarity ${getRarityClass(item.rarity)}">(${item.rarity})</p>
                        <button class="use-button" data-item-index="${index}">사용</button>
                    `;
                    inventoryModalContentDiv.appendChild(itemCard);
                });
            }

            showModal("인벤토리", "보유 아이템 목록", inventoryModalContentDiv.outerHTML);

            // Re-attach event listeners after modal content is rendered
            modalRewards.querySelectorAll('.use-button').forEach(button => {
                button.onclick = (event) => useItem(parseInt(event.target.dataset.itemIndex));
            });
        };

        // Item Use
        const useItem = (index) => {
            if (!isAuthReady || !userId) {
                showModal("로그인 필요", "아이템을 사용하려면 로그인해야 합니다.");
                return;
            }

            const itemToUse = character.inventory[index];
            if (!itemToUse) return;

            let message = `'${itemToUse.name}'을(를) 사용했습니다.`; let effectApplied = false;
            switch (itemToUse.effect.type) {
                case "exp_multiplier":
                    const bonusExp = Math.floor(character.expToNextLevel * (itemToUse.effect.value - 1));
                    character.exp += bonusExp; message += `\n경험치 ${bonusExp} 추가 획득!`; effectApplied = true;
                    checkLevelUp(); break;
                case "gold_bonus":
                    character.gold += itemToUse.effect.value; message += `\n골드 ${itemToUse.effect.value} 획득!`; effectApplied = true; break;
                case "auto_complete_action":
                    message += `\n'${itemToUse.name}' 효과 발동 (기능 미구현 - ${itemToUse.effect.value / 60}분 미만 행동 즉시 완료)`; effectApplied = true; break;
                case "weapon":
                    character.equipped.weapon = { name: itemToUse.name, attack: itemToUse.effect.attack };
                    message += `\n무기 '${itemToUse.name}' 장착 (공격력 ${itemToUse.effect.attack})`; effectApplied = true; break;
                default: message += "\n(아직 구현되지 않은 효과입니다.)";
            }
            if (effectApplied) {
                character.inventory.splice(index, 1);
                showModal("아이템 사용", message); updateUI(); saveCharacterData();
            } else { showModal("아이템 사용 불가", "이 아이템은 현재 사용할 수 없습니다."); }
        };

        // Shop System
        const renderShop = () => {
            if (!isAuthReady || !userId) {
                showModal("로그인 필요", "상점을 이용하려면 로그인해야 합니다.");
                return;
            }

            shopListEl.innerHTML = '';
            shopItems.forEach(item => {
                const itemCard = document.createElement('div');
                itemCard.className = 'item-card';
                itemCard.innerHTML = `
                    <img src="${item.graphic || 'https://placehold.co/60x60/FFD700/000000?text=SHOP'}" alt="Shop Item Icon">
                    <p class="item-name">${item.name}</p>
                    <p class="item-rarity ${getRarityClass(item.rarity || '일반')}">${item.description}</p>
                    <p class="item-price">${item.price} 골드</p>
                    <button class="buy-button" data-item-id="${item.id}">구매</button>
                `;
                shopListEl.appendChild(itemCard);
            });
            shopListEl.querySelectorAll('.buy-button').forEach(button => {
                button.onclick = (event) => {
                    const itemId = event.target.dataset.itemId;
                    const itemToBuy = shopItems.find(item => item.id === itemId);
                    if (itemToBuy) buyItem(itemToBuy);
                };
            });
            showModal("상점", "원하는 아이템을 구매하세요!", shopListEl.outerHTML);
        };

        const buyItem = (item) => {
            if (!isAuthReady || !userId) {
                showModal("로그인 필요", "아이템을 구매하려면 로그인해야 합니다.");
                return;
            }

            if (character.gold >= item.price) {
                character.gold -= item.price;
                character.inventory.push({ ...item });
                showModal("구매 완료", `'${item.name}'을(를) 구매했습니다!`);
                addCombatLog(`상점에서 '${item.name}' 구매!`);
                updateUI(); saveCharacterData();
            } else { showModal("골드 부족", "골드가 부족합니다!"); }
        };

        // Utility Functions
        const showModal = (title, message, htmlContent = '') => {
            modalTitle.textContent = title; modalMessage.textContent = message;
            modalRewards.innerHTML = htmlContent; modalOverlay.classList.remove('hidden');
        };

        const closeModal = () => modalOverlay.classList.add('hidden');

        const addCombatLog = (message) => {
            const logEntry = document.createElement('p');
            logEntry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            combatLogEl.prepend(logEntry);
            if (combatLogEl.children.length > 20) { combatLogEl.removeChild(combatLogEl.lastChild); }
        };

        // Event Listeners
        profileSection.addEventListener('click', () => {
            profileSection.classList.toggle('collapsed');
            toggleIcon.classList.toggle('fa-chevron-up');
            toggleIcon.classList.toggle('fa-chevron-down');
        });
        startButton.addEventListener('click', startAction);
        completeActionButton.addEventListener('click', completeAction);
        modalCloseButton.addEventListener('click', closeModal);
        bottomIcon.addEventListener('click', renderShop);
        bottomInventoryIcon.addEventListener('click', renderInventory);

        // Initialize Firebase and load game data on window load
        window.onload = initializeFirebase;
    </script>
</body>
</html>
